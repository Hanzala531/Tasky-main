<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tasky</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="../Css/style.css">
  <style>
    .navbar {
      margin-right: 40px !important;
    }

    /* Improved Custom Alert Styling */
    .custom-alert {
      position: fixed;
      top: 18%;
      left: 55%;
      transform: translate(-50%, -50%) translateY(-20px);
      padding: 15px 25px;
      border-radius: 8px;
      color: white;
      z-index: 1000;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
      opacity: 0;
      transition: opacity 0.4s, transform 0.4s;
      text-align: center;
      min-width: 280px;
      font-weight: 500;
      letter-spacing: 0.3px;
    }

    .alert-success {
      background: linear-gradient(145deg, #32b954, #27a844);
      border-left: 5px solid #218838;
    }

    .alert-error {
      background: linear-gradient(145deg, #dc3545, #c82333);
      border-left: 5px solid #bd2130;
    }

    .alert-info {
      background: linear-gradient(145deg, #17a2b8, #138496);
      border-left: 5px solid #117a8b;
    }

    .alert-visible {
      opacity: 1;
      transform: translate(-50%, -50%) translateY(0);
    }

    /* Enhanced Todo list styling */
    .todo-container {
      padding: 25px;
      /* background-color: ; */
      /* border-radius: 10px; */
      /* box-shadow: 0 2px 10px rgba(0,0,0,0.05); */
    }

    .todo-container h3 {
      margin-bottom: 20px;
      color: #343a40;
      font-weight: 600;
    }

    .todo-item {
      display: flex;
      align-items: center;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 12px;
      background-color: #f8f9fa;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }

    .todo-item:hover {
      background-color: #f1f3f5;
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .todo-item.completed {
      text-decoration: line-through;
      opacity: 0.7;
      background-color: #f0f8ff;
    }

    .todo-checkbox {
      margin-right: 15px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .todo-text {
      flex-grow: 1;
      font-size: 16px;
      color: #495057;
    }

    .todo-actions {
      margin-left: auto;
      display: flex;
      gap: 8px;
    }

    .todo-form {
      display: flex;
      margin-bottom: 25px;
      width: 70vw;
      gap: 10px;
    }

    .todo-form input {
      flex-grow: 1;
      padding: 12px 15px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 15px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    .todo-form input:focus {
      border-color: #80bdff;
      outline: 0;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .btn-primary {
      background-color: #0d6efd;
      border-color: #0d6efd;
      padding: 12px 20px;
      font-weight: 500;
      transition: all 0.3s;
    }

    .btn-primary:hover {
      background-color: #0b5ed7;
      border-color: #0a58ca;
      transform: translateY(-1px);
    }

    .btn-danger {
      background-color: #dc3545;
      border-color: #dc3545;
      transition: all 0.3s;
    }

    .btn-danger:hover {
      background-color: #c82333;
      border-color: #bd2130;
    }

    .loading,
    .error {
      padding: 20px;
      text-align: center;
      color: #6c757d;
      font-weight: 500;
    }

    .error {
      color: #dc3545;
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <div class="left-sidebar">
      <div class="left-sidebar-header">
        <h2>TASKY</h2>
      </div>
      <div class="left-sidebar-content">
        <ul>
          <li><a id="dashboard" href="../index.html"><img src="../Svg/dasboard.svg" alt="icon-image">Dashboard</a></li>
          <li><a href="./Analytics.html" id="analytic"><img src="../Svg/analytic.svg" alt="icon-image">Analytic</a></li>
          <li><a href="./projects.html" id="projects"><img src="../Svg/projects.svg" alt="icon-image">Projects</a></li>
          <li><a href="./Teams.html" id="Teams"> <img src="../Svg/teams.svg" alt="icon-image">Teams</a></li>
          <li><a href="./timesheets.html" id="Timesheets"><img src="../Svg/timesheets.svg" width="20px"
                alt="icon-image">Timesheets</a></li>
          <li><a href="#" id="todos"><img src="../Svg/todos.svg" alt="icon-image">Todos</a></li>
          <li><a href="./settings.html" id="settings"><img src="../Svg/settings.svg" alt="icon-image">Settings</a></li>
        </ul>
      </div>
    </div>

    <div class="right-container">
      <div class="navbar">
        <div class="navLeft ">
          <h4>Dashboard</h4>
        </div>
        <div class="navCenter">
          <input type="text" placeholder="Search Project">
          <img src="../Svg/search.svg" width="20px" alt="search icon">
        </div>
        <div class="navRight">
          <!-- Notification Icon -->
          <div class="notification">
            <img src="../Svg/notification.svg" id="notify" width="25px" alt="notification icon">
            <div class="notif-dropdown">
              <p id="notif-dropdown">No notifications available</p>
              <!-- Example Notifications -->
              <!-- <a href="#">New comment on your post</a>
      <a href="#">Your order has been shipped</a>
      <a href="#">System update available</a> -->
            </div>
          </div>

          <!-- User Profile -->
          <div class="user">
            <img src="../Images/user.jpeg" width="30px" alt="user icon">
            <span id="nameUser">John Doe</span>
            <div class="dropdown">
              <a href="#">Profile</a>
              <a href="#">Settings</a>
              <a href="#" id="logout-link">Logout</a>
            </div>
          </div>
        </div>
      </div>

      <div class="content-box">
        <!-- Todos container will be loaded here -->
        <div class="todo-container">
          <h3>My Todos</h3>
          <div class="todo-form">
            <input type="text" id="new-todo" placeholder="Add a new todo...">
            <button class="btn btn-primary" id="add-todo-btn">Add Todo</button>
          </div>
          <div id="todos-list">
            <!-- Todos will be loaded here -->
            <div class="loading">Loading todos...</div>
          </div>
        </div>
      </div>

    </div>

    <!-- Alert container -->
    <div id="alert-container"></div>

    <script>
      function isTokenExpired(token) {
        if (!token) {
          return true;
        } // If no token, consider it expired

        try {
          const payloadBase64 = token.split('.')[1]; // Get the payload part
          const decodedPayload = JSON.parse(atob(payloadBase64)); // Decode base64

          const currentTime = Math.floor(Date.now() / 1000); // Current time in seconds

          return decodedPayload.exp < currentTime; // Compare expiration time
        } catch (error) {
          console.error('Error decoding token:', error);
          return true;
        }
      }

      const token = localStorage.getItem('token');
      if (isTokenExpired(token)) {
        console.log('Token is expired');
      } else {
        console.log('Token is valid');
      }

      // Improved Alert function
      function showAlert(message, type) {
        const alertContainer = document.getElementById('alert-container');

        // Create alert element
        const alertElement = document.createElement('div');
        alertElement.className = `custom-alert alert-${type}`;
        alertElement.textContent = message;

        // Add to container
        alertContainer.appendChild(alertElement);

        // Make visible with a small delay for animation
        setTimeout(() => {
          alertElement.classList.add('alert-visible');
        }, 10);

        // Remove after 2 seconds
        setTimeout(() => {
          alertElement.classList.remove('alert-visible');

          // Remove from DOM after fade out
          setTimeout(() => {
            alertContainer.removeChild(alertElement);
          }, 400);
        }, 2000);
      }

      // Todos API Integration
      document.addEventListener('DOMContentLoaded', function () {
        // Fetch todos when page loads - pass true to indicate it's a page load
        fetchTodos(true);

        // Add event listener for adding new todos
        document.getElementById('add-todo-btn').addEventListener('click', addTodo);

        // Add event listener for enter key on input
        document.getElementById('new-todo').addEventListener('keypress', function (e) {
          if (e.key === 'Enter') {
            addTodo();
          }
        });
      });

      // Function to fetch todos from API
      function fetchTodos(isPageLoad = false) {
        const todosList = document.getElementById('todos-list');
        todosList.innerHTML = '<div class="loading">Loading todos...</div>';

        fetch('http://localhost:4000/api/v1/todos', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          }
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to fetch todos');
            }
            return response.json();
          })
          .then(data => {
            if (data && Array.isArray(data.todos)) {
              displayTodos(data.todos);
            } else if (data && Array.isArray(data)) {
              displayTodos(data);
            } else {
              displayTodos([]);
            }

            // Only show success message if this is a manual page load, not an auto-refresh
            if (isPageLoad) {
              showAlert('Todos loaded successfully', 'success');
            }
          })
          .catch(error => {
            console.error('Error fetching todos:', error);
            todosList.innerHTML = '<div class="error">Failed to load todos. Please try again later.</div>';
            showAlert('Failed to load todos', 'error');
          });
      }

      // Function to display todos - Removed edit button
      function displayTodos(todos) {
        const todosList = document.getElementById('todos-list');
        todosList.innerHTML = '';

        if (!todos || todos.length === 0) {
          todosList.innerHTML = '<p>No todos found. Add a new one to get started!</p>';
          return;
        }

        todos.forEach(todo => {
          const todoItem = document.createElement('div');
          // Check if todo is completed based on status being 'checked'
          const isCompleted = todo.status === 'checked';
          todoItem.className = `todo-item ${isCompleted ? 'completed' : ''}`;
          todoItem.dataset.id = todo._id;

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'todo-checkbox';
          checkbox.checked = isCompleted;
          checkbox.addEventListener('change', () => toggleTodoStatus(todo._id, !isCompleted));

          const todoText = document.createElement('span');
          todoText.className = 'todo-text';
          todoText.textContent = todo.title;

          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'todo-actions';

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'btn btn-sm btn-danger';
          deleteBtn.textContent = 'Delete';
          deleteBtn.addEventListener('click', () => deleteTodo(todo._id));

          actionsDiv.appendChild(deleteBtn);

          todoItem.appendChild(checkbox);
          todoItem.appendChild(todoText);
          todoItem.appendChild(actionsDiv);

          todosList.appendChild(todoItem);
        });
      }

      // Function to add a new todo
      function addTodo() {
        const todoInput = document.getElementById('new-todo');
        const todoText = todoInput.value.trim();

        if (todoText === '') {
          showAlert('Please enter a todo', 'error');
          return;
        }

        fetch('http://localhost:4000/api/v1/todos', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ title: todoText })
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to add todo');
            }
            return response.json();
          })
          .then(data => {
            todoInput.value = '';
            // Pass false here since this is not a manual page load
            fetchTodos(false);
            showAlert('Todo added successfully', 'success');
          })
          .catch(error => {
            console.error('Error adding todo:', error);
            showAlert('Failed to add todo', 'error');
          });
      }

      // Function to toggle todo status - Uses the checked/unchecked API
      function toggleTodoStatus(todoId, completed) {
        fetch(`http://localhost:4000/api/v1/todos/${todoId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ completed })
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to update todo');
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              const todoItem = document.querySelector(`.todo-item[data-id="${todoId}"]`);
              if (completed) {
                todoItem.classList.add('completed');
              } else {
                todoItem.classList.remove('completed');
              }
              showAlert('Todo status updated', 'success');
            } else {
              throw new Error(data.message || 'Failed to update todo');
            }
          })
          .catch(error => {
            console.error('Error updating todo:', error);
            showAlert('Failed to update todo status', 'error');
            // Reset checkbox to previous state - pass false to avoid showing load message
            fetchTodos(false);
          });
      }

      // Function to delete a todo
      function deleteTodo(todoId) {
        fetch(`http://localhost:4000/api/v1/todos/${todoId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          }
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to delete todo');
            }
            return response.json();
          })
          .then(data => {
            const todoItem = document.querySelector(`.todo-item[data-id="${todoId}"]`);
            todoItem.remove();
            showAlert('Todo deleted successfully', 'success');

            // If no todos left, show "no todos" message
            const todosList = document.getElementById('todos-list');
            if (todosList.children.length === 0) {
              todosList.innerHTML = '<p>No todos found. Add a new one to get started!</p>';
            }
          })
          .catch(error => {
            console.error('Error deleting todo:', error);
            showAlert('Failed to delete todo', 'error');
          });
      }
    </script>

    <!-- Js for multiple page Functionality -->
    <script src="../js/APis.js"></script>
    <script src="../js/script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"></script>
</body>

</html>